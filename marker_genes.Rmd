---
title: "C elegans scRNA"
author: "Laura Biggins"
date: "2023-04-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(limma)
library(tidyverse)
library(DT)
```

## Finding genes that are upregulated in certain clusters


```{r, eval = FALSE}
#load("data/clr_norm_scaled_worms.rds")
load("data/clr_norm_scaled_worms_lax.rds")

meta <- worms@meta.data
cluster_names <- as.character(meta$annotate_name)
```


Using the FindMarkers Seurat function

### intestine

```{r, eval = FALSE}
of_interest <- grepl("^3_[1245]", cluster_names) # intestine

x <- meta[of_interest , ]
y <- meta[!of_interest , ]

#intestine_markers0 <- FindMarkers(worms@assays$RNA, cells.1 = rownames(x), cells.2 = rownames(y))
intestine_markers <- FindMarkers(
	worms@assays$RNA, 
	cells.1 = rownames(x), 
	cells.2 = rownames(y),
	test.use = "roc", 
	only.pos = TRUE
)

save(intestine_markers, file = "data/intestine_markers_roc.rds")
```

### body wall muscle

```{r, eval=FALSE}
name_pattern <- "^4_[012]|^1_1"

of_interest <- grepl(name_pattern, cluster_names)
# check
unique(cluster_names[of_interest])

body_wall_muscle_markers <- FindMarkers(
  worms@assays$RNA, 
  cells.1 = rownames(meta)[of_interest], 
  cells.2 = rownames(meta)[!of_interest],
  test.use = "roc", 
	only.pos = TRUE
)

save(body_wall_muscle_markers, file = "data/body_wall_muscle_markers_roc.rds")
```

### pharynx

```{r, eval=FALSE}
name_pattern <- "^26_[012]|^24_1|^41_0|^78_0"

of_interest <- grepl(name_pattern, cluster_names)

unique(cluster_names[of_interest]) # check

pharynx_markers <- FindMarkers(
  worms@assays$RNA, 
  cells.1 = rownames(meta)[of_interest], 
  cells.2 = rownames(meta)[!of_interest],
  test.use = "roc", 
	only.pos = TRUE
)

save(pharynx_markers, file = "data/pharynx_markers_roc.rds")
```

### neurons

```{r, eval = FALSE}
name_pattern <- "^6_[0123]|^10_0|^14_[012]|^1[79]_0|^20_[012]|^22_0|^25_[01]|^2[89]_0|^32_0|^35[01234]|^36_[023]|^39_[0123]|^44_[01]|^46_0|^47_[01]|^4[89]_0|^5[01245]_0|^51_1|^6[1235689]_0|^70_[01]|^7[1234567]_0|^8[0134567]_0|^9[01234789]_0|^10[01346789]_0|^11[1234578]_0|^12[0123789]_0|^13[012345678]_0|^14[0245]_0"

of_interest <- grepl(name_pattern, cluster_names)

unique(cluster_names[of_interest]) # check

neuron_markers <- FindMarkers(
  worms@assays$RNA, 
  cells.1 = rownames(meta)[of_interest], 
  cells.2 = rownames(meta)[!of_interest],
  test.use = "roc", 
	only.pos = TRUE
)

save(neuron_markers, file = "data/neuron_markers_roc.rds")
```


## Identified genes

```{r}
show_up_genes <- function(markers){
	up_genes <- markers %>%
  	filter(avg_log2FC > 0) %>%
  	arrange(desc(avg_log2FC)) 

	DT::datatable(up_genes)
}
```


### intestine

```{r}
load("data/intestine_markers_roc.rds")
DT::datatable(intestine_markers)
#show_up_genes(intestine_markers)
```

Looking at vit-6 on the calicolabs interface, it does seem to be a good marker, but cluster 3_5 has very little data and so does not show as being expressed at the later time points.
I'll start with this table and then add info to it:
	- proportion of non 0 counts for each time point across all clusters of interest individually, then a summarised value
		same but a summary value across all other clusters
Add option to filter columns,
2 decimal places
		
pct.1: The percentage of cells where the gene is detected in the first group

pct.2: The percentage of cells where the gene is detected in the second group

data always contains the log-normed version of counts


```{r}
#int <- rownames(intestine_markers)
load("data/worm_counts_qc_filt.rds")
int_mat <- worm_counts_qc_filt[rownames(intestine_markers),]

# I'm assuming d5_1 and d5_2 are reps 1 and 2.
intestine_tbl <- as_tibble(int_mat[,], rownames="gene") %>%
	pivot_longer(cols=-gene) %>%
	separate_wider_delim(cols=name, delim="_", names = c(NA, "day", "rep")) %>%
  mutate(day = factor(day, levels = c("d1","d3","d5","d8","d11","d15"))) 

timepoint_pct <- intestine_tbl %>%
	mutate(non_zero = value>0) %>%
	group_by(gene, day) %>%
	summarise(
	  n = n(),
	  non_zero_count = sum(non_zero)
	) %>%
	ungroup() %>%
	mutate(pct = 100*(non_zero_count/n)) %>%
	select(-n, -non_zero_count) 

timepoint_mins <- timepoint_pct %>%
	group_by(gene) %>%
	summarise(min_day = min(pct))

timepoint_pct <- timepoint_pct %>%
	pivot_wider(names_from = day, values_from = pct, names_prefix = "non0_") %>%
	left_join(timepoint_mins)
#show_up_genes(intestine_markers)
```

```{r}
intestine_info <- intestine_markers %>%
	tibble::rownames_to_column(var = "gene") %>%
	full_join(timepoint_pct) 

intestine_info %>%
	DT::datatable(rownames = FALSE, filter = "top") %>%
	formatRound(columns=2:ncol(intestine_info), digits=3)
```

### body wall muscle

```{r}
load("data/body_wall_muscle_markers_roc.rds")
DT::datatable(body_wall_muscle_markers)
#show_up_genes(body_wall_muscle_markers)
```


### pharynx

```{r}
load("data/pharynx_markers_roc.rds")
DT::datatable(pharynx_markers)
#show_up_genes(pharynx_markers)
```


### neurons

```{r}
load("data/neuron_markers_roc.rds")
DT::datatable(neuron_markers)
#show_up_genes(neuron_markers)
```














```{r, echo = FALSE, eval=FALSE}
rownames(up_genes)

all_cells <- as.matrix(worms@assays$RNA@counts[rownames(up_genes), ])

#one_gene  <- all_cells[1,]

tbl_selected <- as_tibble(all_cells, rownames = "gene") %>%
	pivot_longer(cols = -gene, values_to = "count", names_to = "cell") %>%
  mutate(type = ifelse(cell %in% rownames(x), "marker", "other"))

tbl_intestine <- tbl_selected %>%
  filter(type == "marker")


tbl_selected %>%
	ggplot(aes(x = gene, y = log2(count))) +
	geom_boxplot(outlier.shape = NA, alpha = 0.5) +
	geom_jitter(data = tbl_intestine, size = 1, colour = "blue", alpha = 0.5, width = 0.2, height = 0) +
	coord_flip()

tbl_selected %>%
	ggplot(aes(x = gene, y = log2(count), colour = type)) +
	geom_boxplot(outlier.shape = NA, alpha = 0.5)

VlnPlot(worms,features="dct-16")

```







